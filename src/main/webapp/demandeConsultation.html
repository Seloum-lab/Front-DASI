<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Demande de Consultation</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    </head>
    <header>
        <h1>Predict'IF</h1>
        <h1>Demande de consultation</h1>
        <div id='profilUtilisateur'></div>
        <a href='dashboard_client.html'>Retour</a>
        
        <style>
            #messagexBoxCustom {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                justify-content: center;
                align-items: center;
            }

            #messageBoxContenu {
                background-color: white;
                padding: 20px;
                border-radius: 5px;
                text-align: center;
            }

        </style>
    </header>
    <body>
        <table id="listeMediums"></table>
        <div id="messagexBoxCustom">
            <div id="messageBoxContenu">
                <h1 id="nomMediumConfirmBox"></h1>
                <p id="presentationMediumConfirmBox"></p>
                <button id="buttonRetour">Retour</button>
                <button id="buttonConsulter">Consulter</button>
            </div>
        </div>
        
        <script>
            let idMediumPourLaConsultation = null; // une fois la case clique, on met l id du medium en question qui se trouve dans lid de la case pour ensuite le passe au button confirm qui fait la requete ajax
            $("#buttonRetour").on("click", function() {
                // button retour sur la message box
                // on cache la message box
                $("#messageBoxCustom").toggle();
            }); 
            
            $("#buttonConsulter").on("click", function() {
                // envoyer une requet ajax avec lid du medium en question
              
                $.ajax({
                        url: './ActionServlet',
                        method: 'POST',
                        data: {
                            todo: 'prendreRdvConsultation',
                            idMedium: idMediumPourLaConsultation
                        },
                        dataType: 'json'
                    })
                    .done( function (response) { 
                        // TODO check si la consultation a bien ete prise, sinon notifier l utilisateur
                        console.log("Response: " + response.demandeConsultation);  
                        if(response.demandeConsultation) { 
                            alert("Votre demande a bien ete prise en compte. Vous avez pris un rendez vous"); 
                        } else {
                            alert("Erreur lors de la demande. Votre rendez vous n a pas abouti");
                        } 
                    })
                    .fail( function (error) { 
                        // TODO
                    })
                    .always( function () { // Fonction toujours appelée
                        // TODO
                    });
                $("#messageBoxCustom").toggle();
            });
            
            $(document).ready( function () {
                let xmlhttp = new XMLHttpRequest(); //Construction de la request
                xmlhttp.open("GET", "./ActionServlet?todo=afficherListeMedium", true); //Lancer la requête
                
                xmlhttp.onreadystatechange = function() { //Handler pour la réponse
                    let DONE = 4, OK = 200;
                    if (xmlhttp.readyState === DONE && xmlhttp.status === OK) {
                        console.log("test");
                        let jsonResponse = JSON.parse(xmlhttp.responseText); //parsing du Json
                        //Recuperation des JsonArray
                        // affichage de la liste des mediums
                        let table = $("#listeMediums"); // on get la table dans le document HTML
                        let listeMediums = jsonResponse.listeMediums; 
                        let cte = 0; // compteur pour le nombre de meduims par ligne
                        let ligne = $("<tr></tr>"); // une ligne dans le tableau
                        for(let i = 0; i < listeMediums.length; i++) { // pcq 3 mediums par ligne
                            let uneCase = $("<th></th>");
                            let title = $("<h1></h1>");
                            $(title).text(listeMediums[i].nom);
                            let presentation = $("<p></p>");
                            $(presentation).text(listeMediums[i].presentation);
                            uneCase.append(title);
                            uneCase.append(presentation);
                            $(uneCase).attr('idMedium', listeMediums[i].id); // identifiant de la case est id du medium pour savoir quel medium est selectionne au clique
                            
                            uneCase.on("click", function() {
                                // on veut que lorsqu un medium est clique, mettre son id qui est l id de l element uneCase dans la requete au cas ou l utilisateur demande un rdv avec le medium en question
                                tabData = ($(event.currentTarget)).children(); // fils de la case qui a ete cliquee
                                $("#messagexBoxCustom").show(); 
                                idMediumPourLaConsultation = $(uneCase).attr("idMedium"); // on met l id du medium clique
                                $("#nomMediumConfirmBox").text($(tabData[0]).text());
                                $("#presentationMediumConfirmBox").text($(tabData[1]).text());                                
                            });
                            if(cte === 3) {
                                table.append(ligne); // on ajoute la ligne remplie au tableau
                                ligne = $("<tr></tr>"); // on reprend une nouvelle ligne
                                cte = 0; // reset le compteur
                            }
                            ligne.append(uneCase); // on ajoute la case a la ligne
                            cte++; // on met a jour le nombre de cases dans la ligne
                        }
                        table.append(ligne);
                    }
                };    
                xmlhttp.send(null);   
            });
        </script>
    </body>
</html>
