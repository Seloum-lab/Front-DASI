<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>DASHBOARD</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="https://cdn.syncfusion.com/ej2/dist/ej2.min.js" type="text/javascript"></script>
    </head>
    <header>
        <!--La navbar qui redirige vers d'autres pages-->
        <nav>
            <ul>
                <li id="buttonAccueil"><a href="dashboard_employe.html">Accueil</a></li>
                <li id="buttonConsultation"><a href="consultation_employe.html">Mes Consultation</a></li>
                <li id="butonListeClients"><a href="affichage_clients.html">Liste des clients</a></li>
                <li id="buttonDeconnecter"><a href="login.html">Se déconnecter</a></li>
            </ul>
        </nav>
    </header>
    <body>
        <h1>Tableau de bord</h1>
        <div id = "carte"></div>
        <div id = "top_medium">
            <p>Top 5 mediums</p>
            <ul>
                <li id = "top1"></li>
                <li id = "top2"></li>
                <li id = "top3"></li>
                <li id = "top4"></li>
                <li id = "top5"></li>
            </ul>
        </div>
        <div id = "repartition_employe"></div>
        <div id = "repartition_medium"></div>
        
        <script>
            $(document).ready( function () {
                let xmlhttp = new XMLHttpRequest(); //Construction de la request
                xmlhttp.open("GET", "./ActionServlet?todo=statistics", true); //Lancer la requête
                
                
                xmlhttp.onreadystatechange = function() { //Handler pour la réponse
                    let DONE = 4, OK = 200;
                    if (xmlhttp.readyState === DONE && xmlhttp.status === OK) {
                        let jsonResponse = JSON.parse(xmlhttp.responseText); //parsing du Json
                        //Recuperation des JsonArray
                        const jsonMedium = jsonResponse.medium_liste;
                        const jsonRepartEmploye = jsonResponse.repartition_employe;
                        const jsonRepartMedium = jsonResponse.repartition_medium;
                        
                        //Initialisation des valeurs pour le pie chart
                        let dataSourceEmploye = [];
                        let dataSourceMedium = [];
                        let total = 0;
                         
                        //Parcours du top 5 medium et actualisation du HTML
                        for (let i = 0; i<5 && i<jsonMedium.length; i++) {
                            $("#top" + (i+1)).text(jsonMedium[i].nom);
 
                            //Probleme avec le back des autres, top 5 medium pas toujours 5 !
                        }

                        //Parcours de la repartition de consultation par employe et remplissage du dataSource pour la pie chart 
                        for (const element of jsonRepartEmploye) {
                            let obj = {x: "" + element.id + " : " + element.nom, y: element.nombre_consultations};
                            dataSourceEmploye.push(obj);
                            total += element.nombre_consultations; //Pour avoir le nombre de consultation total
                        }
                        
                        for (const element of jsonRepartMedium) {
                            let obj = {x: "" + element.id + " : " + element.nom, y : element.nombre_consultations};
                            dataSourceMedium.push(obj);
                        }
                        var pieEmploye = new ej.charts.AccumulationChart({
                            //Initializing Series
                            title: "Repartition des consultations par employes (Total : " + total + ")",
                            series: [
                                {
                                    dataSource: dataSourceEmploye,
                                    dataLabel: {
                                        visible: false,
                                        position: 'Inside'
                                    },
                                    xName: 'x',
                                    yName: 'y'
                                }
                            ]
                            });
                            pieEmploye.appendTo('#repartition_employe');
                            
                        var pieMedium = new ej.charts.AccumulationChart({
                            //Initializing Series
                            title: "Repartition des consultations par medium (Total : " + total + ")",
                            series: [
                                {
                                    dataSource: dataSourceMedium,
                                    dataLabel: {
                                        visible: false,
                                        position: 'Inside'
                                    },
                                    xName: 'x',
                                    yName: 'y'
                                }
                            ]
                            });
                            pieMedium.appendTo('#repartition_medium');
                    } 
                };
                xmlhttp.send(null);
                
                
                
            });
        </script>
    </body>
</html>
