<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>DASHBOARD</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="https://cdn.syncfusion.com/ej2/dist/ej2.min.js" type="text/javascript"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    </head>
    <header>
        <!--La navbar qui redirige vers d'autres pages-->
        <nav>
            <ul>
                <li id="buttonAccueil"><a href="dashboard_employe.html">Accueil</a></li>
                <li id="buttonConsultation"><a href="consultation_employe.html">Mes Consultation</a></li>
                <li id="butonListeClients"><a href="affichage_clients.html">Liste des clients</a></li>
                <li id="buttonDeconnecter"><a href="login.html">Se déconnecter</a></li>
            </ul>
        </nav>
    </header>
    <body>
        <h1>Tableau de bord</h1>
        <div id = "carte"></div>
        
        
        
        
        <div id = "repartition_employe"></div>
        <div id = "repartition_medium"></div>
        
        <div id="map" style="height: 600px; width: 80%; margin: 0 auto;"></div>
        
        <canvas id="myChart" style="width:100%;max-width:600px"></canvas>
        
        <script type="text/javascript">

            var googleMapInstance = null;

            function makeInfoWindow(title) {
                return new google.maps.InfoWindow({
                    content: '<div>Information: ' + title + '</div>'
                });
            }

            function attachInfoWindow(marker, infowindow, htmlDescription) {
                marker.addListener('click', function () {

                    infowindow.setContent(htmlDescription);
                    infowindow.open(googleMapInstance, this);
                });
            }

            function initMap() {

                googleMapInstance = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 45.7601424, lng: 4.8961779},
                    zoom: 5
                });

                
               

                // Simuler un appel AJAX (attente 5s)
                setTimeout(
                        function() {},
                        5000
                        );
            }

            function generateMarkers(lat, lng, genre, nom) {

                // Petite popup Google Maps
                var infowindow = makeInfoWindow('');


                

                var iconImage = null; // marker par défaut
                var title;
                if (genre === "homme") title = "Notre cher client ";
                else title = "Notre chère cliente ";


                var marker = new google.maps.Marker({
                    map: googleMapInstance,
                    position: {lat: lat , lng: lng},
                    title: title + nom,
                    icon: iconImage
                });

                attachInfoWindow(
                        marker, infowindow,
                        '<div><strong><a href="./endroit.html?' + '">Endroit #' +  '</a></strong><br/>Ceci est l\'endroit charmant numéro '  + '<br/>' + 'Incroyable !' + '</div>'
                        );
                

            }

        </script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAhf3JleYpal9S-xouJYH8lf7Dvz5Y2Nko&callback=initMap">
        </script>
        
        <script>
            $(document).ready( function () {
                let xmlhttp = new XMLHttpRequest(); //Construction de la request
                xmlhttp.open("GET", "./ActionServlet?todo=statistics", true); //Lancer la requête
                
                
                xmlhttp.onreadystatechange = function() { //Handler pour la réponse
                    let DONE = 4, OK = 200;
                    if (xmlhttp.readyState === DONE && xmlhttp.status === OK) {
                        let jsonResponse = JSON.parse(xmlhttp.responseText); //parsing du Json
                        //Recuperation des JsonArray
                        const jsonMedium = jsonResponse.medium_liste;
                        const jsonRepartEmploye = jsonResponse.repartition_employe;
                        const jsonRepartMedium = jsonResponse.repartition_medium;
                        const jsonClient = jsonResponse.client_liste;
                        
                        for (const element of jsonClient) {
                            generateMarkers(parseFloat(element.lat), parseFloat(element.lng), element.genre, element.nom);   
                            console.log("Un client a été ajouté à lat :" + element.lat + " et long : " + element.lng);
                        }
                            
                        
                        //Initialisation des valeurs pour le pie chart
                        let dataSourceEmploye = [];
                        let dataSourceMedium = [];
                        let total = 0;
                         
                        //Parcours du top 5 medium et actualisation du HTML
                        

                        //Parcours de la repartition de consultation par employe et remplissage du dataSource pour la pie chart 
                        for (const element of jsonRepartEmploye) {
                            let obj = {x: "" + element.id + " : " + element.nom, y: element.nombre_consultations};
                            dataSourceEmploye.push(obj);
                            total += element.nombre_consultations; //Pour avoir le nombre de consultation total
                        }
                        
                        for (const element of jsonRepartMedium) {
                            let obj = {x: "" + element.id + " : " + element.nom, y : element.nombre_consultations};
                            dataSourceMedium.push(obj);
                        }
                        
                        const xValues = [];
                        for (let i = 0; i<5 && i<jsonMedium.length; i++) {
        
                            xValues.push("Top " + (i+1) + ": " + jsonMedium[i].nom);
 
                            //Probleme avec le back des autres, top 5 medium pas toujours 5 !
                        }
                        const yValues = [100, 80, 60, 40, 20];
                        const barColors = "white";
                        const borderColor = "rgba(125, 135, 250, 1)";

                        new Chart("myChart", {
                          type: "bar",
                          data: {
                            labels: xValues,
                            datasets: [{
                              backgroundColor: barColors,
                              borderColor : borderColor,
                              borderWidth: 1,
                              data: yValues
                            }]
                          },
                          options: {
                                legend: {display: false},
                                title: {
                                  display: true,
                                  text: "Meilleurs mediums"
                                },
                                scales: {
                                  yAxes: [{
                                    display : false,
                                    ticks: {
                                      beginAtZero: true, // Pour commencer l'axe y à zéro
                                      suggestedMin: 0, // Valeur minimale suggérée pour l'axe y
                                      suggestedMax: Math.max(...yValues) + 10 // Valeur maximale suggérée pour l'axe y (ajout de 10 pour donner de l'espace)
                                    },
                                    gridLines: {
                                      display: false // Pour cacher les lignes de la grille de fond
                                    }
                                  }]
                                }
                          }
                        });
                        var pieEmploye = new ej.charts.AccumulationChart({
                            //Initializing Series
                            title: "Repartition des consultations par employes (Total : " + total + ")",
                            series: [
                                {
                                    dataSource: dataSourceEmploye,
                                    dataLabel: {
                                        visible: false,
                                        position: 'Inside'
                                    },
                                    xName: 'x',
                                    yName: 'y'
                                }
                            ]
                            });
                            pieEmploye.appendTo('#repartition_employe');
                            
                        var pieMedium = new ej.charts.AccumulationChart({
                            //Initializing Series
                            title: "Repartition des consultations par medium (Total : " + total + ")",
                            series: [
                                {
                                    dataSource: dataSourceMedium,
                                    dataLabel: {
                                        visible: false,
                                        position: 'Inside'
                                    },
                                    xName: 'x',
                                    yName: 'y'
                                }
                            ]
                            });
                            pieMedium.appendTo('#repartition_medium');
                    } 
                };
                xmlhttp.send(null);
                
                
                
            });
        </script>
    </body>
</html>
